<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Universal Scraper Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body class="bg-slate-900 text-gray-100">
  <!-- Navigation -->
  <nav class="bg-slate-800 border-b border-slate-700 px-6 py-4">
    <div class="flex justify-between items-center">
      <div class="flex items-center gap-3">
        <i class="fas fa-spider text-blue-400 text-2xl"></i>
        <h1 class="text-xl font-bold">Universal Scraper Pro</h1>
      </div>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2 text-sm">
          <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
          <span id="status">Ready</span>
        </div>
        <button id="exportBtn" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-sm">
          <i class="fas fa-download mr-1"></i>Export
        </button>
        <button id="settingsBtn" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-sm">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto py-6 px-6">
    <!-- Stats Overview -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-slate-800 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-blue-400" id="newsCount">0</div>
        <div class="text-sm text-gray-400">News Articles</div>
      </div>
      <div class="bg-slate-800 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-green-400" id="cryptoCount">0</div>
        <div class="text-sm text-gray-400">Crypto Coins</div>
      </div>
      <div class="bg-slate-800 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-pink-400" id="productCount">0</div>
        <div class="text-sm text-gray-400">Products</div>
      </div>
      <div class="bg-slate-800 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-yellow-400" id="lastUpdate">Never</div>
        <div class="text-sm text-gray-400">Last Update</div>
      </div>
    </div>

    <!-- Control Panel -->
    <div class="bg-slate-800 rounded-lg p-6 mb-8">
      <div class="flex flex-wrap justify-center gap-4">
        <button id="runAllBtn" class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg font-semibold transition flex items-center gap-2">
          <i class="fas fa-play"></i>Run All Scrapers
        </button>
        <button id="autoRefreshBtn" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg transition flex items-center gap-2">
          <i class="fas fa-sync"></i>Auto Refresh: OFF
        </button>
        <button id="clearAllBtn" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded-lg transition flex items-center gap-2">
          <i class="fas fa-trash"></i>Clear All
        </button>
      </div>
    </div>

    <!-- DASHBOARD GRID -->
    <div class="grid lg:grid-cols-3 gap-6 mb-8">
      <!-- NEWS -->
      <div class="bg-slate-800 rounded-xl shadow-xl p-6 hover:shadow-2xl transition-shadow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i class="fas fa-newspaper text-blue-400"></i>Latest News
          </h2>
          <button id="loadNews" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-md text-sm transition-colors flex items-center gap-1">
            <i class="fas fa-sync text-xs"></i>Refresh
          </button>
        </div>
        <div class="overflow-hidden rounded-lg border border-slate-700">
          <table class="w-full text-sm">
            <thead class="bg-slate-700 text-gray-300">
              <tr>
                <th class="py-2 px-3 text-left">Title</th>
                <th class="py-2 px-3 text-left">Source</th>
                <th class="py-2 px-3 text-left">Link</th>
              </tr>
            </thead>
            <tbody id="newsTable" class="divide-y divide-slate-700"></tbody>
          </table>
        </div>
      </div>

      <!-- CRYPTO -->
      <div class="bg-slate-800 rounded-xl shadow-xl p-6 hover:shadow-2xl transition-shadow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i class="fab fa-bitcoin text-yellow-400"></i>Crypto Prices
          </h2>
          <button id="loadCrypto" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md text-sm transition-colors flex items-center gap-1">
            <i class="fas fa-sync text-xs"></i>Refresh
          </button>
        </div>
        <div class="overflow-hidden rounded-lg border border-slate-700">
          <table class="w-full text-sm">
            <thead class="bg-slate-700 text-gray-300">
              <tr>
                <th class="py-2 px-3 text-left">Name</th>
                <th class="py-2 px-3 text-left">Price</th>
                <th class="py-2 px-3 text-left">Change</th>
              </tr>
            </thead>
            <tbody id="cryptoTable" class="divide-y divide-slate-700"></tbody>
          </table>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div class="bg-slate-800 rounded-xl shadow-xl p-6 hover:shadow-2xl transition-shadow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i class="fas fa-shopping-cart text-pink-400"></i>Products
          </h2>
          <button id="loadProducts" class="bg-pink-600 hover:bg-pink-700 px-3 py-1 rounded-md text-sm transition-colors flex items-center gap-1">
            <i class="fas fa-sync text-xs"></i>Refresh
          </button>
        </div>
        <div class="overflow-hidden rounded-lg border border-slate-700">
          <table class="w-full text-sm">
            <thead class="bg-slate-700 text-gray-300">
              <tr>
                <th class="py-2 px-3 text-left">Title</th>
                <th class="py-2 px-3 text-left">Price</th>
                <th class="py-2 px-3 text-left">URL</th>
              </tr>
            </thead>
            <tbody id="productTable" class="divide-y divide-slate-700"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Analytics Chart -->
    <div class="bg-slate-800 rounded-xl shadow-xl p-6">
      <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <i class="fas fa-chart-bar text-purple-400"></i>Data Analytics
      </h3>
      <div class="h-64">
        <canvas id="analyticsChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    let autoRefreshInterval;
    let chart;
    let allData = { news: [], crypto: [], products: [] };

    function updateStats() {
      document.getElementById('newsCount').textContent = allData.news.length;
      document.getElementById('cryptoCount').textContent = allData.crypto.length;
      document.getElementById('productCount').textContent = allData.products.length;
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }

    function updateChart() {
      const ctx = document.getElementById('analyticsChart').getContext('2d');
      if (chart) chart.destroy();
      
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['News', 'Crypto', 'Products'],
          datasets: [{
            data: [allData.news.length, allData.crypto.length, allData.products.length],
            backgroundColor: ['#3b82f6', '#10b981', '#ec4899'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#9ca3af' } }
          }
        }
      });
    }

    async function fetchAndRender(url, tableId, mapFn, loadingText = 'Loading...', dataType) {
      const table = document.getElementById(tableId);
      const status = document.getElementById('status');
      
      table.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>${loadingText}</td></tr>`;
      status.textContent = `Loading ${dataType}...`;
      
      try {
        const res = await fetch(url);
        const response = await res.json();
        
        if (response.status === 'error') {
          table.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Error: ${response.message}</td></tr>`;
          status.textContent = 'Error';
          return;
        }
        
        const data = response.data || response;
        allData[dataType] = data;
        
        if (!data || data.length === 0) {
          table.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500"><i class="fas fa-inbox mr-2"></i>No data available</td></tr>';
        } else {
          table.innerHTML = data.map(mapFn).join("");
        }
        
        updateStats();
        updateChart();
        status.textContent = 'Ready';
      } catch (error) {
        console.error('Fetch error:', error);
        table.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-400"><i class="fas fa-wifi mr-2"></i>Network error</td></tr>';
        status.textContent = 'Network Error';
      }
    }

    function exportData() {
      const data = {
        timestamp: new Date().toISOString(),
        news: allData.news,
        crypto: allData.crypto,
        products: allData.products
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `scraper-data-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function toggleAutoRefresh() {
      const btn = document.getElementById('autoRefreshBtn');
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        btn.innerHTML = '<i class="fas fa-sync mr-1"></i>Auto Refresh: OFF';
        btn.classList.remove('bg-green-600', 'hover:bg-green-500');
        btn.classList.add('bg-gray-600', 'hover:bg-gray-500');
      } else {
        autoRefreshInterval = setInterval(() => {
          document.getElementById('runAllBtn').click();
        }, 60000); // 1 minute
        btn.innerHTML = '<i class="fas fa-sync fa-spin mr-1"></i>Auto Refresh: ON';
        btn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
        btn.classList.add('bg-green-600', 'hover:bg-green-500');
      }
    }

    function clearAllData() {
      ['newsTable', 'cryptoTable', 'productTable'].forEach(id => {
        document.getElementById(id).innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No data</td></tr>';
      });
      allData = { news: [], crypto: [], products: [] };
      updateStats();
      if (chart) chart.destroy();
    }

    document.getElementById("loadNews").onclick = () =>
      fetchAndRender("/scrape/news", "newsTable", item => `
        <tr class="hover:bg-slate-700 transition-colors">
          <td class="py-3 px-3">
            <div class="font-medium text-gray-200">${(item.title || '—').substring(0, 50)}${item.title?.length > 50 ? '...' : ''}</div>
            <div class="text-xs text-gray-400 mt-1">${new Date(item.published).toLocaleDateString() || 'Today'}</div>
          </td>
          <td class="py-3 px-3">
            <span class="bg-blue-600 text-xs px-2 py-1 rounded">${item.source || '—'}</span>
          </td>
          <td class="py-3 px-3">
            <a href="${item.link || '#'}" class="text-blue-400 hover:text-blue-300 transition-colors" target="_blank">
              <i class="fas fa-external-link-alt"></i>
            </a>
          </td>
        </tr>`, 'Fetching latest news...', 'news');

    document.getElementById("loadCrypto").onclick = () =>
      fetchAndRender("/scrape/crypto", "cryptoTable", item => `
        <tr class="hover:bg-slate-700 transition-colors">
          <td class="py-3 px-3">
            <div class="font-semibold text-gray-200">${item.name || '—'}</div>
            <div class="text-xs text-gray-400">${item.symbol || ''}</div>
          </td>
          <td class="py-3 px-3 font-mono text-green-400">$${parseFloat(item.price || 0).toLocaleString()}</td>
          <td class="py-3 px-3">
            <span class="font-semibold ${parseFloat(item.change_24h) >= 0 ? 'text-green-400' : 'text-red-400'}">
              ${parseFloat(item.change_24h) >= 0 ? '+' : ''}${parseFloat(item.change_24h || 0).toFixed(2)}%
            </span>
          </td>
        </tr>`, 'Fetching crypto prices...', 'crypto');

    document.getElementById("loadProducts").onclick = () =>
      fetchAndRender("/scrape/products", "productTable", item => `
        <tr class="hover:bg-slate-700 transition-colors">
          <td class="py-3 px-3">
            <div class="font-medium text-gray-200">${(item.title || '—').substring(0, 35)}${item.title?.length > 35 ? '...' : ''}</div>
          </td>
          <td class="py-3 px-3 font-semibold text-green-400">$${parseFloat(item.price || 0).toFixed(2)}</td>
          <td class="py-3 px-3">
            <a href="${item.url || '#'}" class="text-pink-400 hover:text-pink-300 transition-colors" target="_blank">
              <i class="fas fa-external-link-alt"></i>
            </a>
          </td>
        </tr>`, 'Fetching products...', 'products');

    document.getElementById("runAllBtn").onclick = async () => {
      const btn = document.getElementById("runAllBtn");
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Scraping...';
      btn.disabled = true;
      
      try {
        await fetch("/scrape/all");
        
        // Auto-load all data after scraping
        await Promise.all([
          document.getElementById("loadNews").click(),
          document.getElementById("loadCrypto").click(),
          document.getElementById("loadProducts").click()
        ]);
        
        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete!';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
      } catch (error) {
        btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
      }
    };

    document.getElementById('exportBtn').onclick = exportData;
    document.getElementById('autoRefreshBtn').onclick = toggleAutoRefresh;
    document.getElementById('clearAllBtn').onclick = clearAllData;
    
    // Initialize empty chart
    updateChart();
  </script>
</body>
</html>
